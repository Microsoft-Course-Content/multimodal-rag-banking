<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimodal RAG â€” Banking Document Q&A</title>
    <style>
        :root {
            --primary: #5B2D90;
            --primary-light: #7B4DB5;
            --accent: #00B7C3;
            --success: #107C10;
            --warning: #FF8C00;
            --danger: #D13438;
            --bg: #F9F8FC;
            --card-bg: #FFFFFF;
            --text: #323130;
            --text-light: #605E5C;
            --border: #EDEBE9;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color:white; padding:20px 40px; display:flex; align-items:center; justify-content:space-between;
        }
        .header h1 { font-size:22px; font-weight:600; }
        .header .sub { font-size:13px; opacity:0.85; margin-top:2px; }
        .header .badge { background:rgba(255,255,255,0.15); padding:6px 14px; border-radius:20px; font-size:12px; }

        /* Layout */
        .main { max-width:1200px; margin:0 auto; padding:24px; display:grid; grid-template-columns:380px 1fr; gap:24px; }
        @media(max-width:900px){ .main{grid-template-columns:1fr;} }

        .card { background:var(--card-bg); border-radius:12px; box-shadow:var(--shadow); overflow:hidden; }
        .card-header { padding:14px 20px; border-bottom:1px solid var(--border); font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px; }
        .card-body { padding:20px; }

        /* Sidebar */
        .sidebar { display:flex; flex-direction:column; gap:20px; }

        /* Upload */
        .upload-zone {
            border:2px dashed #C8C6C4; border-radius:10px; padding:30px 16px; text-align:center;
            cursor:pointer; transition:all 0.3s; background:#FAFAFA;
        }
        .upload-zone:hover { border-color:var(--primary); background:#F3EFF8; }
        .upload-zone .icon { font-size:40px; margin-bottom:8px; }
        .upload-zone h3 { font-size:15px; }
        .upload-zone p { font-size:12px; color:var(--text-light); margin-top:4px; }
        #file-input { display:none; }

        .file-item {
            display:flex; align-items:center; gap:10px; padding:10px 14px;
            background:#F3EFF8; border-radius:8px; margin-top:10px; border:1px solid #D8CCE8;
        }
        .file-item .name { font-size:13px; font-weight:600; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .file-item .size { font-size:11px; color:var(--text-light); }
        .file-item .remove { background:none; border:none; color:var(--danger); cursor:pointer; font-size:16px; }

        .btn { padding:10px 20px; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.2s; }
        .btn-primary { background:var(--primary); color:white; width:100%; }
        .btn-primary:hover { background:var(--primary-light); }
        .btn-primary:disabled { background:#C8C6C4; cursor:not-allowed; }
        .btn-sm { padding:6px 14px; font-size:12px; }
        .btn-outline { background:transparent; border:1px solid var(--primary); color:var(--primary); }

        /* Ingested docs list */
        .doc-list { list-style:none; }
        .doc-list li { padding:10px 0; border-bottom:1px solid var(--border); font-size:13px; display:flex; justify-content:space-between; align-items:center; }
        .doc-list li:last-child { border-bottom:none; }
        .doc-list .doc-name { font-weight:600; }
        .doc-list .doc-meta { font-size:11px; color:var(--text-light); }
        .doc-chips { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }
        .chip { background:#E8DEF8; padding:2px 8px; border-radius:10px; font-size:10px; color:var(--primary); }

        /* Chat Area */
        .chat-area { display:flex; flex-direction:column; min-height:600px; }
        .messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }

        .message { max-width:85%; padding:14px 18px; border-radius:16px; line-height:1.6; font-size:14px; animation:fadeIn 0.3s ease; }
        .message.user { background:var(--primary); color:white; align-self:flex-end; border-bottom-right-radius:4px; }
        .message.assistant { background:#F3F2F1; color:var(--text); align-self:flex-start; border-bottom-left-radius:4px; }
        .message .citations { margin-top:10px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.1); font-size:12px; color:var(--text-light); }
        .message .meta { font-size:11px; margin-top:6px; opacity:0.7; }

        .welcome { text-align:center; padding:60px 20px; color:var(--text-light); }
        .welcome .big-icon { font-size:48px; margin-bottom:12px; }
        .welcome h3 { font-size:18px; color:var(--text); margin-bottom:8px; }
        .welcome p { font-size:14px; line-height:1.6; }
        .example-queries { margin-top:20px; display:flex; flex-direction:column; gap:8px; }
        .example-q { padding:10px 16px; background:#F3EFF8; border-radius:8px; cursor:pointer; font-size:13px; text-align:left; transition:background 0.2s; border:1px solid #E8DEF8; }
        .example-q:hover { background:#E8DEF8; }

        /* Input bar */
        .input-bar { padding:16px 20px; border-top:1px solid var(--border); display:flex; gap:10px; align-items:center; background:white; }
        .input-bar input { flex:1; padding:12px 16px; border:1px solid var(--border); border-radius:10px; font-size:14px; font-family:inherit; outline:none; }
        .input-bar input:focus { border-color:var(--primary); box-shadow:0 0 0 2px rgba(91,45,144,0.15); }
        .input-bar button { padding:12px 20px; }

        /* Loading */
        .typing-indicator { display:flex; gap:4px; padding:14px 18px; align-self:flex-start; }
        .typing-indicator span { width:8px; height:8px; border-radius:50%; background:#A0A0A0; animation:bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay:0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay:0.4s; }

        /* Progress bar for ingest */
        .ingest-progress { display:none; margin-top:12px; }
        .progress-bg { background:#E1DFDD; border-radius:6px; height:6px; overflow:hidden; }
        .progress-fill { background:linear-gradient(90deg,var(--primary),var(--accent)); height:100%; border-radius:6px; transition:width 0.5s; width:0%; }
        .progress-text { font-size:12px; color:var(--text-light); margin-top:4px; }

        /* Status bar */
        .status-bar { background:#F3F2F1; padding:8px 40px; font-size:12px; color:var(--text-light); display:flex; justify-content:space-between; border-top:1px solid var(--border); position:fixed; bottom:0; left:0; right:0; }
        .dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; }
        .dot.on { background:var(--success); }
        .dot.off { background:var(--danger); }

        @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        @keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-6px)} }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1>ğŸ” Multimodal RAG â€” Banking Q&A</h1>
        <div class="sub">Upload financial reports â†’ Ask questions â†’ Get grounded answers with citations</div>
    </div>
    <div class="badge">v1.0 â€” Jalal Ahmed Khan</div>
</div>

<div class="main">
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Upload Card -->
        <div class="card">
            <div class="card-header">ğŸ“¤ Ingest Documents</div>
            <div class="card-body">
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <div class="icon">ğŸ“Š</div>
                    <h3>Drop PDF reports here</h3>
                    <p>Financial reports, annual reports, regulatory filings</p>
                </div>
                <input type="file" id="file-input" accept=".pdf" multiple>
                <div id="file-list"></div>
                <div class="ingest-progress" id="ingest-progress">
                    <div class="progress-bg"><div class="progress-fill" id="ingest-bar"></div></div>
                    <div class="progress-text" id="ingest-text">Ingesting...</div>
                </div>
                <button class="btn btn-primary" id="ingest-btn" disabled onclick="ingestDocuments()" style="margin-top:12px;">
                    ğŸ“¥ Ingest into RAG Index
                </button>
            </div>
        </div>

        <!-- Ingested Documents -->
        <div class="card">
            <div class="card-header">ğŸ“š Indexed Documents</div>
            <div class="card-body">
                <ul class="doc-list" id="doc-list">
                    <li style="color:var(--text-light); font-size:13px;">No documents ingested yet. Upload a PDF above.</li>
                </ul>
            </div>
        </div>

        <!-- How It Works -->
        <div class="card">
            <div class="card-header">â„¹ï¸ Architecture</div>
            <div class="card-body" style="font-size:13px; line-height:1.7; color:var(--text-light);">
                <p><strong>Ingest:</strong> PDF â†’ Crack (text+images) â†’ Semantic Chunk â†’ Dual Embed (text ada-002 + image CLIP) â†’ Azure AI Search</p>
                <p style="margin-top:8px;"><strong>Query:</strong> Question â†’ Hybrid Search (keyword + vector + image) â†’ Rerank â†’ GPT-4o Multimodal â†’ Grounded Answer</p>
                <div style="margin-top:12px; padding:10px; background:#F3EFF8; border-radius:6px; font-size:12px;">
                    <strong>Key:</strong> Charts and graphs are embedded as images â€” GPT-4o reads them visually alongside text context.
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="card chat-area">
        <div class="card-header" style="justify-content:space-between;">
            <span>ğŸ’¬ Ask Questions</span>
            <button class="btn btn-outline btn-sm" onclick="clearChat()">Clear</button>
        </div>
        <div class="messages" id="messages">
            <div class="welcome">
                <div class="big-icon">ğŸ¦</div>
                <h3>Ask anything about your banking documents</h3>
                <p>Upload and ingest a PDF report, then ask questions. Answers are grounded in the document with page citations.</p>
                <div class="example-queries">
                    <div class="example-q" onclick="askExample(this)">ğŸ“ˆ What was the revenue growth trend in Q3?</div>
                    <div class="example-q" onclick="askExample(this)">ğŸ’° What is the total loan portfolio and its composition?</div>
                    <div class="example-q" onclick="askExample(this)">âš ï¸ What are the key risk factors mentioned in the report?</div>
                    <div class="example-q" onclick="askExample(this)">ğŸ“Š Describe the chart showing capital adequacy ratios</div>
                </div>
            </div>
        </div>
        <div class="input-bar">
            <input type="text" id="query-input" placeholder="Ask a question about your documents..." onkeydown="if(event.key==='Enter')askQuestion()">
            <button class="btn btn-primary" style="width:auto;" onclick="askQuestion()">Ask</button>
        </div>
    </div>
</div>

<div class="status-bar">
    <span><span class="dot" id="api-dot"></span><span id="api-text">Checking API...</span></span>
    <span>Hybrid Search: keyword + vector + image | Generation: GPT-4o multimodal</span>
</div>

<script>
    const API = window.location.origin;
    let selectedFiles = [];
    let ingestedDocs = [];

    // â”€â”€â”€ File Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');

    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor='var(--primary)'; });
    uploadZone.addEventListener('dragleave', () => { uploadZone.style.borderColor='#C8C6C4'; });
    uploadZone.addEventListener('drop', e => {
        e.preventDefault(); uploadZone.style.borderColor='#C8C6C4';
        [...e.dataTransfer.files].forEach(f => { if(f.name.endsWith('.pdf')) addFile(f); });
    });
    fileInput.addEventListener('change', e => { [...e.target.files].forEach(f => addFile(f)); });

    function addFile(file) {
        if(selectedFiles.find(f => f.name === file.name)) return;
        selectedFiles.push(file);
        renderFileList();
    }

    function removeFile(idx) {
        selectedFiles.splice(idx, 1);
        renderFileList();
    }

    function renderFileList() {
        const el = document.getElementById('file-list');
        el.innerHTML = selectedFiles.map((f, i) => `
            <div class="file-item">
                <span>ğŸ“„</span>
                <span class="name">${f.name}</span>
                <span class="size">${(f.size/1024/1024).toFixed(1)}MB</span>
                <button class="remove" onclick="removeFile(${i})">âœ•</button>
            </div>
        `).join('');
        document.getElementById('ingest-btn').disabled = selectedFiles.length === 0;
    }

    // â”€â”€â”€ Ingest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function ingestDocuments() {
        const btn = document.getElementById('ingest-btn');
        btn.disabled = true; btn.textContent = 'Ingesting...';
        const prog = document.getElementById('ingest-progress');
        prog.style.display = 'block';

        for(let i = 0; i < selectedFiles.length; i++) {
            const pct = ((i + 0.5) / selectedFiles.length * 100);
            document.getElementById('ingest-bar').style.width = pct + '%';
            document.getElementById('ingest-text').textContent = `Processing ${selectedFiles[i].name}...`;

            try {
                const fd = new FormData();
                fd.append('file', selectedFiles[i]);
                const resp = await fetch(`${API}/api/v1/ingest`, { method:'POST', body:fd });
                if(resp.ok) {
                    const result = await resp.json();
                    ingestedDocs.push(result);
                }
            } catch(err) {
                // Demo mode fallback
                ingestedDocs.push({
                    filename: selectedFiles[i].name,
                    pages_processed: Math.floor(Math.random()*30)+5,
                    text_chunks: Math.floor(Math.random()*100)+20,
                    images_indexed: Math.floor(Math.random()*15)+2,
                    total_documents_indexed: Math.floor(Math.random()*120)+25,
                    processing_time_seconds: (Math.random()*10+3).toFixed(1),
                });
            }
        }

        document.getElementById('ingest-bar').style.width = '100%';
        document.getElementById('ingest-text').textContent = 'Done!';
        renderDocList();
        selectedFiles = [];
        renderFileList();
        btn.disabled = false; btn.textContent = 'ğŸ“¥ Ingest into RAG Index';
        setTimeout(() => { prog.style.display = 'none'; }, 2000);
    }

    function renderDocList() {
        const el = document.getElementById('doc-list');
        if(ingestedDocs.length === 0) {
            el.innerHTML = '<li style="color:var(--text-light);font-size:13px;">No documents ingested yet.</li>';
            return;
        }
        el.innerHTML = ingestedDocs.map(d => `
            <li>
                <div>
                    <div class="doc-name">ğŸ“„ ${d.filename}</div>
                    <div class="doc-chips">
                        <span class="chip">${d.pages_processed} pages</span>
                        <span class="chip">${d.text_chunks} chunks</span>
                        <span class="chip">${d.images_indexed} images</span>
                    </div>
                </div>
                <div class="doc-meta">${d.processing_time_seconds}s</div>
            </li>
        `).join('');
    }

    // â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function askExample(el) { document.getElementById('query-input').value = el.textContent.slice(2).trim(); askQuestion(); }

    async function askQuestion() {
        const input = document.getElementById('query-input');
        const q = input.value.trim();
        if(!q) return;
        input.value = '';

        // Remove welcome screen
        const welcome = document.querySelector('.welcome');
        if(welcome) welcome.remove();

        addMessage(q, 'user');
        showTyping();

        try {
            const resp = await fetch(`${API}/api/v1/query`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ query: q, top_k: 5 })
            });
            removeTyping();
            if(resp.ok) {
                const result = await resp.json();
                addAssistantMessage(result);
            } else {
                throw new Error('API error');
            }
        } catch {
            removeTyping();
            // Demo response
            addAssistantMessage(generateDemoAnswer(q));
        }
    }

    function addMessage(text, role) {
        const el = document.createElement('div');
        el.className = `message ${role}`;
        el.textContent = text;
        document.getElementById('messages').appendChild(el);
        el.scrollIntoView({behavior:'smooth'});
    }

    function addAssistantMessage(result) {
        const el = document.createElement('div');
        el.className = 'message assistant';
        let html = `<div>${formatAnswer(result.answer)}</div>`;
        if(result.citations && result.citations.length) {
            html += `<div class="citations">ğŸ“ Sources: ${result.citations.map(c => `Page ${c.page} (${c.source})`).join(' Â· ')}</div>`;
        }
        html += `<div class="meta">${result.chunks_used || 0} chunks Â· ${result.images_used || 0} images Â· ${(result.processing_time_seconds || 0).toFixed(1)}s</div>`;
        el.innerHTML = html;
        document.getElementById('messages').appendChild(el);
        el.scrollIntoView({behavior:'smooth'});
    }

    function formatAnswer(text) {
        return text.replace(/\[Page (\d+)\]/g, '<strong style="color:var(--primary);">[Page $1]</strong>').replace(/\n/g, '<br>');
    }

    function showTyping() {
        const el = document.createElement('div');
        el.className = 'typing-indicator'; el.id = 'typing';
        el.innerHTML = '<span></span><span></span><span></span>';
        document.getElementById('messages').appendChild(el);
        el.scrollIntoView({behavior:'smooth'});
    }

    function removeTyping() { document.getElementById('typing')?.remove(); }

    function clearChat() {
        document.getElementById('messages').innerHTML = `
            <div class="welcome"><div class="big-icon">ğŸ¦</div><h3>Ask anything about your banking documents</h3>
            <p>Upload and ingest a PDF report, then ask questions.</p></div>`;
    }

    function generateDemoAnswer(q) {
        const answers = {
            default: `Based on the indexed documents, here's what I found:\n\nThe financial report shows strong performance across key metrics. Revenue grew by 12.3% year-over-year [Page 4], driven primarily by growth in the retail banking segment. The net interest margin improved to 3.2% [Page 8], while the cost-to-income ratio decreased to 34.5% [Page 12].\n\nThe capital adequacy ratio chart on [Page 15] shows the bank maintaining a comfortable buffer above the regulatory minimum of 13%, with the current ratio at 17.8%.\n\nTotal provisions for credit losses increased by 8% [Page 22], reflecting a prudent approach to risk management in the current economic environment.`,
        };
        return {
            answer: answers.default,
            citations: [{page:4,source:'annual_report.pdf'},{page:8,source:'annual_report.pdf'},{page:15,source:'annual_report.pdf'}],
            chunks_used: 5, images_used: 2, processing_time_seconds: 2.8,
        };
    }

    // â”€â”€â”€ Health Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkHealth() {
        try {
            const r = await fetch(`${API}/api/v1/health`);
            if(r.ok) { document.getElementById('api-dot').className='dot on'; document.getElementById('api-text').textContent='API Connected'; }
        } catch {
            document.getElementById('api-dot').className='dot off';
            document.getElementById('api-text').textContent='API Offline â€” Demo Mode';
        }
    }
    checkHealth();
</script>
</body>
</html>
